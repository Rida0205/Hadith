<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="DEENWAY – Hadiths: مشروع متخصص في عرض الأحاديث النبوية مصنفة حسب كتب السنة المعتمدة.">
    
    <!-- SEO Meta Tags -->
    <title>DEENWAY – Hadiths | الأحاديث النبوية</title>
    <meta name="title" content="DEENWAY – Hadiths | الأحاديث النبوية">
    <meta name="description" content="مشروع متخصص في عرض الأحاديث النبوية مصنفة حسب كتب السنة المعتمدة.">
    <meta name="keywords" content="أحاديث نبوية, السنة النبوية, صحيح البخاري, صحيح مسلم, كتب الحديث">
    <meta property="og:title" content="DEENWAY – Hadiths | الأحاديث النبوية">
    <meta property="og:description" content="مشروع متخصص في عرض الأحاديث النبوية مصنفة حسب كتب السنة المعتمدة.">
    <meta property="og:url" content="https://hadiths.ondeenway.org">
    <meta property="og:type" content="website">
    
    <!-- Sitemap -->
    <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="https://blogger.googleusercontent.com/img/a/AVvXsEiqV8QiI-kiTFfd7Aqm5-JjxGOrxYPRJ568gGkeMVQ5pe6EJLyQb77iaztmC7pFSTa0UglxZeKunFA-nlk6kpw1U8_GICQTG6096qeCqxTG3PdBtg5Jdt67b7e2NrgDglKyQE-CzdSLkDQk2PP6Vp1hmcf8nB1ICh4GgYhNAFtl8nbAbKZcV54UpjHwfbVB">
    
    <!-- الخطوط -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&family=Tajawal:wght@300;400;500;700&family=El+Messiri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* CSS Reset وتحسينات عامة - نفس تصميمك الأصلي مع تعديلات الأداء */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2c786c;
            --secondary-color: #004445;
            --accent-color: #f8b500;
            --light-color: #f8f9fa;
            --dark-color: #2c3e50;
            --gray-color: #6c757d;
            --light-gray: #f1f3f5;
            --border-radius: 10px;
            --box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
            --hero-gradient: linear-gradient(135deg, #2c786c 0%, #004445 100%);
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Cairo', 'Tajawal', sans-serif;
            font-size: 18px;
            line-height: 1.8;
            color: var(--dark-color);
            background-color: #fff;
            direction: rtl;
            text-align: right;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        a { text-decoration: none; color: var(--primary-color); transition: var(--transition); }
        a:hover { color: var(--secondary-color); }
        ul { list-style: none; }
        h1, h2, h3, h4 { font-family: 'Tajawal', sans-serif; font-weight: 700; line-height: 1.3; margin-bottom: 1rem; color: var(--dark-color); }
        p { margin-bottom: 1.5rem; line-height: 1.8; }
        .section { padding: 100px 0; }
        .section-header { text-align: center; margin-bottom: 70px; }
        .section-title { font-size: 2.8rem; position: relative; display: inline-block; margin-bottom: 1.5rem; }
        .section-title::after {
            content: ''; position: absolute; width: 80px; height: 5px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            bottom: -15px; right: 50%; transform: translateX(50%); border-radius: 5px;
        }
        .section-subtitle { font-size: 1.3rem; color: var(--gray-color); max-width: 700px; margin: 0 auto; line-height: 1.6; }
        .highlight { color: var(--primary-color); font-weight: 700; }
        .btn { display: inline-block; padding: 14px 35px; border-radius: var(--border-radius); font-weight: 600; font-size: 1.1rem; cursor: pointer; transition: var(--transition); border: none; text-align: center; }
        .btn-primary { background: rgba(255, 255, 255, 0.15); color: white; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
        .btn-primary:hover { background: rgba(255, 255, 255, 0.25); transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); }
        
        /* الهيدر */
        .main-header { background-color: rgba(255, 255, 255, 0.95); box-shadow: 0 2px 30px rgba(0, 0, 0, 0.08); position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; padding: 20px 0; backdrop-filter: blur(10px); transition: transform 0.3s ease, background-color 0.3s ease; }
        .main-header.scrolled { background-color: rgba(255, 255, 255, 0.98); box-shadow: 0 2px 30px rgba(0, 0, 0, 0.1); }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .logo h1 { font-size: 2.2rem; margin-bottom: 5px; color: var(--dark-color); }
        .logo-highlight { color: var(--primary-color); position: relative; }
        .logo-highlight::after { content: ''; position: absolute; width: 100%; height: 3px; background: linear-gradient(90deg, var(--primary-color), transparent); bottom: -2px; right: 0; }
        .tagline { font-size: 1rem; color: var(--gray-color); margin-bottom: 0; font-style: italic; }
        
        /* البانر الرئيسي */
        .hero { background: var(--hero-gradient); color: white; padding: 180px 0 150px; text-align: center; position: relative; overflow: hidden; min-height: 100vh; display: flex; align-items: center; }
        .hero-title { font-family: 'El Messiri', 'Tajawal', sans-serif; font-size: 3.2rem; color: white; margin-bottom: 3rem; text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); font-weight: 600; line-height: 1.4; padding: 0 20px; }
        
        /* أقسام الكتب الحديثية */
        .categories-section { background-color: var(--light-gray); }
        .categories-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 30px; }
        .category-card { background-color: white; border-radius: var(--border-radius); padding: 35px; box-shadow: var(--box-shadow); transition: var(--transition); display: block; color: var(--dark-color); border: 2px solid transparent; height: 100%; position: relative; overflow: hidden; }
        .category-card::before { content: ''; position: absolute; top: 0; right: 0; width: 100%; height: 5px; background: linear-gradient(90deg, var(--primary-color), var(--accent-color)); }
        .category-card:hover { transform: translateY(-10px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15); border-color: var(--light-gray); }
        .category-icon { background: linear-gradient(135deg, rgba(44, 120, 108, 0.1) 0%, rgba(0, 68, 69, 0.1) 100%); width: 70px; height: 70px; border-radius: 18px; display: flex; align-items: center; justify-content: center; margin-bottom: 25px; color: var(--primary-color); font-size: 1.8rem; }
        .category-card h3 { font-size: 1.5rem; margin-bottom: 20px; color: var(--dark-color); }
        .category-card p { color: var(--gray-color); margin-bottom: 25px; font-size: 1.05rem; }
        .hadith-count { display: inline-block; background-color: var(--primary-color); color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: 600; margin-top: 10px; }
        
        /* عرض الكتب الداخلية (Books Grid) - تصميم متجاوب */
        .internal-books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .internal-book-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            border: 1px solid #e9ecef;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 120px;
        }
        .internal-book-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
            box-shadow: var(--box-shadow);
        }
        .internal-book-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 10px;
            line-height: 1.4;
        }
        .internal-book-meta {
            font-size: 0.9rem;
            color: var(--gray-color);
            margin-top: auto;
        }
        .range-badge {
            display: inline-block;
            background: var(--light-gray);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        /* قائمة الأحاديث */
        .hadiths-page { padding: 80px 0; min-height: 70vh; }
        .hadiths-list { display: flex; flex-direction: column; gap: 25px; }
        .hadith-item { background-color: white; border-radius: var(--border-radius); padding: 30px; box-shadow: var(--box-shadow); transition: var(--transition); border: 1px solid var(--light-gray); border-right: 4px solid var(--primary-color); }
        .hadith-item:hover { transform: translateX(-5px); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.12); }
        .hadith-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .hadith-number { background: var(--primary-color); color: white; padding: 5px 12px; border-radius: 8px; font-weight: bold; font-size: 0.9rem; }
        .hadith-text { font-size: 1.25rem; line-height: 2; font-family: 'El Messiri', 'Tajawal', serif; text-align: justify; color: var(--dark-color); white-space: pre-wrap; }
        .read-more-btn { display: inline-flex; align-items: center; gap: 8px; margin-top: 20px; color: var(--primary-color); font-weight: 600; font-size: 1rem; cursor: pointer; }
        .hadith-grade { font-size: 0.9rem; font-weight: 600; }
        .grade-sahih { color: #28a745; }
        .grade-hasan { color: #ffc107; }
        .grade-daif { color: #dc3545; }

        /* صفحة تفاصيل الحديث */
        .hadith-detail-page { padding: 80px 0; min-height: 70vh; }
        .hadith-title { font-size: 2.5rem; color: var(--dark-color); margin-bottom: 25px; line-height: 1.3; text-align: center; }
        .hadith-meta-detail { color: var(--gray-color); font-size: 1.05rem; margin-bottom: 40px; padding-bottom: 25px; border-bottom: 1px solid var(--light-gray); display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 20px; }
        .hadith-text-container { background-color: #f8f5e6; padding: 40px; border-radius: var(--border-radius); margin-bottom: 45px; border-right: 5px solid var(--primary-color); }
        .hadith-text { font-size: 1.8rem; line-height: 2.2; text-align: center; font-family: 'El Messiri', 'Tajawal', serif; color: var(--dark-color); white-space: pre-wrap; }
        .hadith-details { background-color: white; padding: 40px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); line-height: 1.9; font-size: 1.15rem; border: 1px solid var(--light-gray); }
        .detail-item { margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--light-gray); }
        .detail-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .back-link { display: inline-flex; align-items: center; gap: 10px; margin-top: 30px; color: var(--primary-color); font-weight: 600; background-color: var(--light-gray); padding: 12px 25px; border-radius: var(--border-radius); transition: var(--transition); }
        .back-link:hover { background-color: var(--primary-color); color: white; transform: translateX(-5px); }
        
        /* Loader */
        .loader-wrapper { text-align: center; padding: 40px; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(44, 120, 108, 0.1); border-radius: 50%; border-top-color: var(--primary-color); animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* الفوتر */
        .main-footer { background-color: var(--dark-color); color: white; padding: 80px 0 30px; }
        .footer-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 50px; margin-bottom: 40px; }
        .footer-logo h3 { color: white; margin-bottom: 10px; font-size: 1.8rem; }
        .footer-logo .tagline { color: rgba(255, 255, 255, 0.7); }
        .footer-section p { color: rgba(255, 255, 255, 0.8); line-height: 1.6; }
        .footer-section h4 { color: white; font-size: 1.4rem; margin-bottom: 25px; position: relative; padding-bottom: 12px; }
        .footer-section h4::after { content: ''; position: absolute; width: 60px; height: 3px; background: linear-gradient(90deg, var(--accent-color), transparent); bottom: 0; right: 0; }
        .footer-links li { margin-bottom: 15px; }
        .footer-links a { color: rgba(255, 255, 255, 0.8); display: flex; align-items: center; gap: 10px; transition: var(--transition); }
        .footer-links a:hover { color: white; padding-right: 10px; }
        .footer-bottom { padding-top: 35px; text-align: center; color: rgba(255, 255, 255, 0.7); font-size: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1); font-style: italic; }
        
        /* زر العودة للأعلى */
        .back-to-top { position: fixed; bottom: 30px; left: 30px; background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white; width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; cursor: pointer; transition: var(--transition); opacity: 0; visibility: hidden; z-index: 999; box-shadow: 0 5px 20px rgba(44, 120, 108, 0.3); }
        .back-to-top.show { opacity: 1; visibility: visible; }
        .back-to-top:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(44, 120, 108, 0.4); }
        .header-spacer { height: 80px; }
        
        /* التجاوب */
        @media (max-width: 992px) { .hero-title { font-size: 2.7rem; } .section-title { font-size: 2.5rem; } .section { padding: 80px 0; } .hadith-title { font-size: 2.2rem; } .hadith-text { font-size: 1.5rem; } .hadith-text-container { padding: 30px; } }
        @media (max-width: 768px) { .hero { padding: 150px 0 100px; min-height: 90vh; } .hero-title { font-size: 2.2rem; padding: 0 15px; } .section-title { font-size: 2rem; } .section-subtitle { font-size: 1.15rem; } .logo h1 { font-size: 1.8rem; } .back-to-top { bottom: 20px; left: 20px; width: 50px; height: 50px; } .hadith-text { font-size: 1.4rem; line-height: 1.9; } }
        @media (max-width: 576px) { .container { padding: 0 15px; } .features-grid, .categories-grid { grid-template-columns: 1fr; } .hero { padding: 130px 0 80px; min-height: 80vh; } .hero-title { font-size: 1.9rem; } .section { padding: 60px 0; } .feature-card, .category-card { padding: 25px; } .footer-content { grid-template-columns: 1fr; gap: 40px; } .hadith-text { font-size: 1.3rem; line-height: 1.8; } }
    </style>
</head>
<body>
    <!-- الهيدر -->
    <header class="main-header" id="mainHeader">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="#home" style="color: inherit; text-decoration: none;">
                        <h1>DEENWAY – <span class="logo-highlight">Hadiths</span></h1>
                        <p class="tagline">الأحاديث النبوية مصنفة حسب الكتب المعتمدة</p>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- مسافة للهيدر الثابت -->
    <div class="header-spacer"></div>

    <!-- البانر الرئيسي -->
    <section class="hero" id="heroSection">
        <div class="container">
            <div class="hero-content">
                <h2 class="hero-title">مشروع متخصص في عرض الأحاديث النبوية مصنفة حسب كتب السنة المعتمدة</h2>
                <a href="#categories" class="btn btn-primary" id="exploreBtn">استكشاف كتب الأحاديث</a>
            </div>
        </div>
    </section>

    <!-- أقسام كتب الأحاديث (الرئيسية) -->
    <section id="categories" class="section categories-section">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">كتب الأحاديث النبوية</h2>
                <p class="section-subtitle">اختر الكتاب الذي تريد استعراض أحاديثه</p>
            </div>
            <div class="categories-grid">
                <a href="#book/bukhari" class="category-card">
                    <div class="category-icon"><i class="fas fa-book"></i></div>
                    <h3>صحيح البخاري</h3>
                    <p>أصح كتاب بعد كتاب الله تعالى، جمعه الإمام محمد بن إسماعيل البخاري.</p>
                    <span class="hadith-count">7,275 حديث</span>
                </a>
                <a href="#book/muslim" class="category-card">
                    <div class="category-icon"><i class="fas fa-book"></i></div>
                    <h3>صحيح مسلم</h3>
                    <p>ثاني أصح الكتب بعد البخاري، جمعه الإمام مسلم بن الحجاج النيسابوري.</p>
                    <span class="hadith-count">4,000 حديث</span>
                </a>
                <a href="#book/tirmidhi" class="category-card">
                    <div class="category-icon"><i class="fas fa-book"></i></div>
                    <h3>سنن الترمذي</h3>
                    <p>جامع الترمذي أو سنن الترمذي، من تصنيف الإمام محمد بن عيسى الترمذي.</p>
                    <span class="hadith-count">3,956 حديث</span>
                </a>
                <a href="#book/abu-dawud" class="category-card">
                    <div class="category-icon"><i class="fas fa-book"></i></div>
                    <h3>سنن أبي داود</h3>
                    <p>من تصنيف الإمام أبو داود سليمان بن الأشعث السجستاني.</p>
                    <span class="hadith-count">4,800 حديث</span>
                </a>
                <a href="#book/nasai" class="category-card">
                    <div class="category-icon"><i class="fas fa-book"></i></div>
                    <h3>سنن النسائي</h3>
                    <p>المجتبى من السنن للنسائي، جمعه الإمام أحمد بن شعيب النسائي.</p>
                    <span class="hadith-count">5,270 حديث</span>
                </a>
                <a href="#book/ibn-majah" class="category-card">
                    <div class="category-icon"><i class="fas fa-book"></i></div>
                    <h3>سنن ابن ماجه</h3>
                    <p>من تصنيف الإمام محمد بن يزيد ابن ماجة القزويني.</p>
                    <span class="hadith-count">4,341 حديث</span>
                </a>
            </div>
        </div>
    </section>

    <!-- عرض الكتب الداخلية (Internal Books View) -->
    <section id="internal-books-view" class="section" style="display: none;">
        <div class="container">
            <div class="page-header" style="margin-bottom: 40px;">
                <a href="#categories" class="back-link"><i class="fas fa-arrow-right"></i> العودة للكتب</a>
            </div>
            <div class="section-header">
                <h2 id="internal-books-title" class="section-title">الكتاب</h2>
                <p class="section-subtitle">اختر الكتاب الداخلي لعرض الأحاديث</p>
            </div>
            
            <div id="loading-indicator" class="loader-wrapper" style="display: none;">
                <div class="spinner"></div>
                <p>جاري معالجة البيانات وتصنيف الكتب...</p>
            </div>

            <div class="internal-books-grid" id="internal-books-grid">
                <!-- سيتم ملؤها ديناميكياً -->
            </div>
        </div>
    </section>

    <!-- عرض الأحاديث (Hadiths View) -->
    <section id="hadiths-view" class="section hadiths-page" style="display: none;">
        <div class="container">
            <div class="page-header">
                <a href="#" id="back-to-internal-books" class="back-link"><i class="fas fa-arrow-right"></i> العودة للكتب الداخلية</a>
            </div>
            <div class="section-header">
                <h2 id="current-internal-book-title" class="section-title">عنوان الكتاب الداخلي</h2>
            </div>
            <div class="hadiths-list" id="hadiths-list">
                <!-- الأحاديث ستظهر هنا -->
            </div>
        </div>
    </section>

    <!-- صفحة عرض حديث مفرد -->
    <section id="hadith-detail-container" class="section hadith-detail-page" style="display: none;">
        <div class="container">
            <a href="#" id="back-to-hadiths-list" class="back-link"><i class="fas fa-arrow-right"></i> العودة إلى قائمة الأحاديث</a>
            
            <div class="hadith-meta-detail" id="hadith-meta-detail"></div>
            <div class="hadith-text-container">
                <p class="hadith-text" id="hadith-text-content"></p>
            </div>
            <div class="hadith-details">
                <div class="detail-item">
                    <h4>معلومات الحديث</h4>
                    <div id="hadith-info-content"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- فوتر -->
    <footer class="main-footer" id="contact">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>روابط سريعة</h4>
                    <ul class="footer-links">
                        <li><a href="https://www.ondeenway.org" target="_blank"><i class="fas fa-external-link-alt"></i> DEENWAY</a></li>
                        <li><a href="https://ebook.ondeenway.org" target="_blank"><i class="fas fa-external-link-alt"></i> مكتبة DEENWAY</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <div class="footer-logo">
                        <h3>DEENWAY – <span class="logo-highlight">Hadiths</span></h3>
                        <p class="tagline">الأحاديث النبوية مصنفة حسب الكتب المعتمدة</p>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h4>اتصل بنا</h4>
                    <p>للاستفسارات:</p>
                    <p class="contact-email" style="background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 5px; display:inline-block; margin-top:10px;">contact@ondeenway.org</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>إن أصبت فمن الله، وإن أخطأت فمن نفسي والشيطان</p>
            </div>
        </div>
    </footer>

    <!-- زر العودة للأعلى -->
    <div class="back-to-top" id="backToTop"><i class="fas fa-arrow-up"></i></div>

    <script>
        // --- إعدادات الملفات ---
        const BOOK_FILES = {
            'bukhari': 'bukh.json',
            'muslim': 'mus.json',
            'tirmidhi': 'tir.json',
            'abu-dawud': 'daw.json',
            'nasai': 'nis.json',
            'ibn-majah': 'majah.json'
        };

        const BOOK_INFO = {
            'bukhari': { title: "صحيح البخاري" },
            'muslim': { title: "صحيح مسلم" },
            'tirmidhi': { title: "سنن الترمذي" },
            'abu-dawud': { title: "سنن أبي داود" },
            'nasai': { title: "سنن النسائي" },
            'ibn-majah': { title: "سنن ابن ماجه" }
        };

        // --- حالة التطبيق ---
        const state = {
            currentBookSlug: null,
            rawJsonData: [],      // البيانات الخام من الملف
            internalBooksMap: {}, // Map: Book Name -> Array of Hadiths
            sortedBooks: [],      // Array of Book Names in order of appearance
            currentInternalBook: null,
            currentHadithIndex: null
        };

        // --- تهيئة الأحداث ---
        document.addEventListener('DOMContentLoaded', () => {
            setupBackToTop();
            setupHeaderScroll();
            setupExploreButton();
            handleRouting();
            window.addEventListener('hashchange', handleRouting);
        });

        // --- التوجيه (Routing) ---
        function handleRouting() {
            const hash = window.location.hash;
            
            // إخفاء كل الصفحات الفرعية
            document.getElementById('internal-books-view').style.display = 'none';
            document.getElementById('hadiths-view').style.display = 'none';
            document.getElementById('hadith-detail-container').style.display = 'none';
            document.getElementById('categories').style.display = 'none';
            document.getElementById('heroSection').style.display = 'none';

            if (!hash || hash === '#home' || hash === '') {
                document.getElementById('categories').style.display = 'block';
                document.getElementById('heroSection').style.display = 'flex';
                window.scrollTo(0,0);
                return;
            }

            if (hash.startsWith('#book/')) {
                const bookSlug = hash.split('/')[1];
                loadMainBook(bookSlug);
            } else if (hash.startsWith('#internal/')) {
                const parts = hash.split('/');
                const internalIndex = parseInt(parts[1]);
                loadInternalBook(internalIndex);
            } else if (hash.startsWith('#hadith/')) {
                const parts = hash.split('/');
                const internalIndex = parseInt(parts[1]);
                const hadithIndex = parseInt(parts[2]);
                loadHadithDetail(internalIndex, hadithIndex);
            } else {
                // عودة افتراضية
                window.location.hash = '#home';
            }
        }

        // --- تحميل الكتاب الرئيسي ومعالجة البيانات ---
        async function loadMainBook(bookSlug) {
            if (!BOOK_FILES[bookSlug]) return alert('كتاب غير موجود');

            state.currentBookSlug = bookSlug;
            
            // UI Updates
            document.getElementById('internal-books-view').style.display = 'block';
            document.getElementById('internal-books-title').textContent = BOOK_INFO[bookSlug].title;
            document.getElementById('internal-books-grid').innerHTML = '';
            document.getElementById('loading-indicator').style.display = 'block';
            window.scrollTo(0,0);

            try {
                const response = await fetch(BOOK_FILES[bookSlug]);
                if (!response.ok) throw new Error('فشل تحميل الملف');
                const data = await response.json();
                
                // معالجة البيانات (تجميع الكتب الداخلية)
                processDataIntoBooks(data);
                
                // عرض الكتب الداخلية
                renderInternalBooks();
                document.getElementById('loading-indicator').style.display = 'none';

            } catch (error) {
                console.error(error);
                document.getElementById('loading-indicator').innerHTML = `<div style="color:#c62828; font-weight:bold;">خطأ: ${error.message}</div>`;
            }
        }

        // --- المنطق الجديد: تصنيف حسب "Book" (الكتب الداخلية) ---
        function processDataIntoBooks(data) {
            state.rawJsonData = data;
            state.internalBooksMap = {};
            state.sortedBooks = [];
            const seenBooks = new Set();

            data.forEach((hadith) => {
                // مفتاح التجميع هو اسم الكتاب (حقل Book)
                const bookName = hadith.Book;
                
                if (!bookName) return; // تجاهل إذا لم يوجد اسم كتاب

                if (!seenBooks.has(bookName)) {
                    seenBooks.add(bookName);
                    state.internalBooksMap[bookName] = [];
                    state.sortedBooks.push(bookName);
                }

                // إضافة الحديث للكتاب الداخلي
                state.internalBooksMap[bookName].push(hadith);
            });
        }

        // --- عرض الكتب الداخلية ---
        function renderInternalBooks() {
            const grid = document.getElementById('internal-books-grid');
            grid.innerHTML = '';

            state.sortedBooks.forEach((bookName, index) => {
                const hadiths = state.internalBooksMap[bookName];
                
                // حساب الأرقام
                const firstNum = extractHadithNumber(hadiths[0]);
                const lastNum = extractHadithNumber(hadiths[hadiths.length - 1]);
                const rangeText = (firstNum && lastNum) ? `${firstNum} - ${lastNum}` : `${hadiths.length} حديث`;

                const card = document.createElement('div');
                card.className = 'internal-book-card';
                card.onclick = () => { window.location.hash = `#internal/${index}`; };
                card.innerHTML = `
                    <div class="internal-book-title">${bookName}</div>
                    <div class="internal-book-meta">
                        <span class="range-badge">${rangeText}</span>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // --- عرض أحاديث كتاب داخلي ---
        function loadInternalBook(internalIndex) {
            if (!state.sortedBooks[internalIndex]) return window.location.hash = '#home';

            const bookName = state.sortedBooks[internalIndex];
            state.currentInternalBook = bookName;
            const hadiths = state.internalBooksMap[bookName];

            document.getElementById('hadiths-view').style.display = 'block';
            document.getElementById('current-internal-book-title').textContent = bookName;
            
            // تحديث زر العودة ليشير للكتاب الرئيسي الحالي
            document.getElementById('back-to-internal-books').href = `#book/${state.currentBookSlug}`;

            const list = document.getElementById('hadiths-list');
            list.innerHTML = '';

            hadiths.forEach((hadith, index) => {
                const hNum = extractHadithNumber(hadith) || (index + 1);
                const grade = hadith.Grade || "";
                const gradeClass = getGradeClass(grade);
                
                // إزالة الإنجليزية من النص (تنظيف بسيط: إزالة الحروف اللاتينية المتتالية)
                const cleanText = removeEnglish(hadith.Arabic_Text);

                const div = document.createElement('div');
                div.className = 'hadith-item';
                div.innerHTML = `
                    <div class="hadith-header">
                        <span class="hadith-number">حديث رقم: ${hNum}</span>
                        <span class="hadith-grade ${gradeClass}">${grade}</span>
                    </div>
                    <div class="hadith-text">${cleanText}</div>
                    <div class="read-more-btn" onclick="window.location.hash='#hadith/${internalIndex}/${index}'">
                        <span>عرض التفاصيل</span> <i class="fas fa-arrow-left"></i>
                    </div>
                `;
                list.appendChild(div);
            });

            window.scrollTo(0,0);
        }

        // --- عرض تفاصيل حديث ---
        function loadHadithDetail(internalIndex, hadithIndex) {
            const bookName = state.sortedBooks[internalIndex];
            const hadith = state.internalBooksMap[bookName][hadithIndex];

            document.getElementById('hadith-detail-container').style.display = 'block';
            document.getElementById('hadith-meta-detail').innerHTML = `
                <span><strong>الكتاب:</strong> ${hadith.Book}</span>
                <span><strong>المرجع:</strong> ${hadith["In-book reference"] || "-"}</span>
                <span><strong>الدرجة:</strong> <span class="hadith-grade ${getGradeClass(hadith.Grade)}">${hadith.Grade}</span></span>
            `;

            // تنظيف النص من الإنجليزية
            document.getElementById('hadith-text-content').textContent = removeEnglish(hadith.Arabic_Text);
            
            document.getElementById('hadith-info-content').innerHTML = `
                <p><strong>الباب:</strong> ${hadith.Chapter_Title_Arabic || ""}</p>
                <p><strong>الرقم:</strong> ${extractHadithNumber(hadith) || "-"}</p>
                ${hadith.Reference ? `<p><a href="${hadith.Reference}" target="_blank">رابط المصدر</a></p>` : ''}
            `;
            
            document.getElementById('back-to-hadiths-list').href = `#internal/${internalIndex}`;
            window.scrollTo(0,0);
        }

        // --- دوال مساعدة ---
        function extractHadithNumber(hadith) {
            if (!hadith["In-book reference"]) return null;
            const match = hadith["In-book reference"].match(/Hadith\s*(\d+)/i);
            return match ? match[1] : null;
        }

        function getGradeClass(grade) {
            if (!grade) return '';
            grade = grade.toLowerCase();
            if (grade.includes("صحيح") || grade.includes("sahih")) return 'grade-sahih';
            if (grade.includes("حسن") || grade.includes("hasan")) return 'grade-hasan';
            if (grade.includes("ضعيف") || grade.includes("da'if")) return 'grade-daif';
            return '';
        }

        // دالة لإزالة النصوص الإنجليزية من النص العربي
        function removeEnglish(text) {
            if (!text) return '';
            // هذا التعبير النمطي يزيل الجمل الإنجليزية، لكنه يحافظ على الأرقام والرموز المفصولة
            // نقوم بإزالة الكلمات المكونة من حروف لاتينية فقط
            return text.replace(/[a-zA-Z]+/g, '').replace(/\s+/g, ' ').trim();
        }

        // --- وظائف واجهة المستخدم القديمة ---
        function setupBackToTop() {
            const btn = document.getElementById('backToTop');
            window.addEventListener('scroll', () => {
                btn.classList.toggle('show', window.scrollY > 300);
            });
            btn.addEventListener('click', () => window.scrollTo({top: 0, behavior: 'smooth'}));
        }
        
        function setupHeaderScroll() {
            const header = document.getElementById('mainHeader');
            window.addEventListener('scroll', () => {
                header.classList.toggle('scrolled', window.scrollY > 50);
            });
        }
        
        function setupExploreButton() {
            document.getElementById('exploreBtn').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('categories').scrollIntoView({behavior: 'smooth'});
            });
        }
    </script>
</body>
</html>
